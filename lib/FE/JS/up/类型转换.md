# JS中的类型转换
<!-- toc -->

> 在ES5规范中定义了一些"抽象操作"和转换规则，如：[ToPrimitive](./toPrimitive.md)、 `ToString`、 `ToNumber`和 `ToBoolean`。这些操作仅供引擎内部使用，和平时JS代码中的 `.toString()` 等操作不同。

## 显式类型转换

- String()
- Boolean()
- Number()
- parseInt()
- parseFloat()

> 显式还是隐式都是相对的，如果主观使用，亦可看为显式的转换，例如：

```js
!!      // 强制转换为 boolean，假值 => false 真值=>true
+'123'  // 强制转换为 number， 失败为NaN
123+''  // 强制转换为 string
```

## 隐式类型转换及转换规则

显式转换和隐式转换应用的规则是一致的，得到的结果也是一致的，这里放在一起讨论。

### 隐式强制转为 string

#### 触发条件

以下情况会强制转为 `string`:

- `二元+`的一侧为字符串或`valueOf`未返回`简单类型值（非对象）`
- 使用ES6中的模版字符串 ``${var}``

#### ToString转换规则

```js
''+null       // "null"
''+undefined  // "undefined"
''+true       // "true"
''+false      // "false"
// 数字的字符串化遵循通用规则
''+21         // '21'
''+NaN        // 'NaN'
''+           // 极大或者极小的数字使用指数形式  
// 调用 ToPrimitive 抽象操作，其中 hint为 number
''+{}         // '[object Object]'
''+[1,2,3]    // '1,2,3'
// 调用 ToPrimitive 抽象操作，其中 hint为 string
`${[1,2,3]}`  // '1,2,3'
```

> 如果对象有自定义的 `toString()` 方法，字符串化时就会调用该自定义方法并使用其返回值，否则返回的是内部属性 `[[Class]]` 的值，如：`[object Object]`

#### 对象的转换

> 对象在进行转换时，通常是为了得到一个 `基本类型的值`（boolean/string/number）

对象的转换 遵循 `ToPrimitive抽象操作` 规则，[戳这里](./toPrimitive.md)了解。

#### +运算符

`+运算符`既可以用作`数字之间的相加`也可以通过重载用于`字符串拼接`

```js
// (简单类型) +运算符两边的操作数有一个及以上是字符串就会进行字符串拼接
4+'21'    // '421'
'4'+'21'  // '421'

// 操作符两侧为非字符串&非object时，会对其进行隐式转换为数字，相加
4+21    // 25
5+true  // 5
// 一元操作符+在其操作数为非数字时，会对其进行隐式转换为数字
+'21'   // 21
```

根据 ES5 规范11.6.1节，如果 `+` 两边的操作数中，有一个操作数是字符串或者可以通过以下步骤转换为字符串，+运算符将进行字符串拼接操作：

- 如果一个操作数为对象，则对其调用`ToPrimitive`抽象操作
- `ToPrimitive`抽象操作会调用 `[[DefaultValue]](hint)`，其中 hint 为 `Number`。

举个例子：

```js
[1,2] + [3,4]   // "1,23,4"
```

在这个操作中，JS 引擎对其进行 `toPrimitive`抽象操作的时候，先执行 `valueOf()`方法，但是由于其 `valueOf()`方法返回的是数组(非简单类型值)，转而调用 `toString()`方法，Array的`toString()`方法返回了以 `,` 拼接的所有元素的字符串，即 `1,2` 和 `3,4`， `+`运算符再进行字符串拼接，得到结果 `1,23,4`。

> 简单来说，只要 `二元+` 的操作数中有一个是字符串，或者可以通过上述步骤得到字符串，就进行字符串拼接操作，其余情况执行数字加法。

### 隐式强制转为 Number

#### 触发条件

以下情况会强制转为 `Number`：

- 算数操作时（`+ - x / % ++ --`），需要注意 `+` 是否为字符串拼接，可参考前文此处不在赘述。
- `== ===`运算时一侧是数字(或对象取原始值后是数字)，另一侧会进行强制转换

#### ToNumber转换规则

```js
+null       // 0
+undefined  // NaN
+true       // 1
+false      // 0
// 字符串为 纯数字 或 包含一个小数 可以转换
+'123'      // 123
+'000123'   // 123
+'123px'    // NaN  此时和parseInt不同  
+'123.00'   // 123.00
+'123.1.2'  // NaN  此时和parseFloat不同
// 对象的转换遵循 ToPrimitive

```

### 隐式强制转为 boolean

#### 触发条件

以下情况会强制转为 `boolean`

- if(`...`) 语句中的条件判断表达式；
- for(..;`..`;..) 语句中的条件判断表达式，也就是第二个；
- while(`..`) 和 do..while(`..`) 循环中的条件判断表达式；
- `..`?..:.. 三元表达式中的条件判断表达式，也就是第一个；
- 逻辑或 `||` 和逻辑与 `&&` `左边的操作数`，作为条件判断表达式；
- 进行 `!` 操作

#### ToBoolean转换规则

ToBoolean 依据 真值和假值来进行判断。

> 假值的布尔强制类型转换结果为 false，在假值列表以外的值都是真值。

JS中的值分为两种：

- 可以被强制类型转换为 false 的值
  - undefined
  - null
  - false
  - +0、 -0 和 NaN
  - ""
- 其他（被强制类型转换为 true 的值）

> `document.all`是唯一的例外，在老版本的 IE 中，`document.all`是一个对象，其强制类型转换结果为 true，而在现代浏览器中，其强制转换结果为 false。
